// Generated by Selenium IDE
const { Builder, By, Key, until } = require('selenium-webdriver')
const firefox = require('selenium-webdriver/firefox')

describe('anadirsaldo', function() {
  this.timeout(60000)
  let driver

  beforeEach(async function() {
    const options = new firefox.Options()
      .addArguments('--headless')
      .addArguments('--width=1920')
      .addArguments('--height=1080');

    driver = await new Builder()
      .forBrowser('firefox')
      .setFirefoxOptions(options)
      .build()
  })

  afterEach(async function() {
    if (driver) await driver.quit();
  })

  it('anadirsaldo', async function() {
    // 1. Ir a la web
    await driver.get("http://localhost:5173/")
    
    // 2. Rellenar Login
    await driver.wait(until.elementLocated(By.css(".ghost")), 10000);
    await driver.findElement(By.css(".ghost")).click()
    
    await driver.wait(until.elementLocated(By.css("label:nth-child(1) > input")), 5000);
    await driver.findElement(By.css("label:nth-child(1) > input")).click()
    await driver.findElement(By.css("label:nth-child(1) > input")).sendKeys("pedrito@gmail.com")
    
    await driver.findElement(By.css("label:nth-child(2) > input")).click()
    await driver.findElement(By.css("label:nth-child(2) > input")).sendKeys("Pedrito")
    
    // 3. Click en entrar
    await driver.findElement(By.css("button")).click()

    // 4. MOMENTO CR√çTICO: Esperar a entrar o CAPTURAR EL ERROR
    try {
        // Esperamos a ver el bot√≥n del dashboard (.actions > .small)
        const botonAcciones = await driver.wait(
            until.elementLocated(By.css(".actions > .small")), 
            10000 
        );
        // Si llegamos aqu√≠, hemos entrado
        await botonAcciones.click();

    } catch (error) {
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // SI ENTRA AQU√ç, ES QUE EL LOGIN FALL√ì. VAMOS A VER POR QU√â.
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        console.log("\n\n################################################");
        console.log("‚ö†Ô∏è EL LOGIN HA FALLADO. DIAGN√ìSTICO:");
        
        // A) ¬øHay alguna alerta visible?
        try {
            let alert = await driver.switchTo().alert();
            console.log("üî¥ ALERTA DETECTADA: " + await alert.getText());
            await alert.accept();
        } catch (e) {
            console.log("‚ö™ No hay alertas nativas (popups).");
        }

        // B) ¬øHay alg√∫n texto de error en rojo en la web?
        try {
           // Buscamos cualquier cosa que parezca un mensaje de error
           let bodyText = await driver.findElement(By.tagName("body")).getText();
           console.log("üìù TEXTO VISIBLE EN PANTALLA:");
           console.log(bodyText); 
        } catch(e) {}

        console.log("################################################\n\n");
        
        // Volvemos a lanzar el error para que GitHub marque el test como fallido
        throw error;
    }

    // RESTO DEL TEST
    const saldo = await driver.wait(until.elementLocated(By.css(".saldo")), 5000);
    await saldo.click()
    
    await driver.findElement(By.css("input")).sendKeys("1")
    await driver.findElement(By.css("input")).click()
    await driver.findElement(By.css("input")).sendKeys("2")
    await driver.findElement(By.css("input")).click()
    {
      const element = await driver.findElement(By.css("input"))
      await driver.actions({ bridge: true}).doubleClick(element).perform()
    }
    await driver.findElement(By.css("input")).sendKeys("3")
    await driver.findElement(By.css("input")).click()
    await driver.findElement(By.css("input")).sendKeys("4")
    await driver.findElement(By.css("input")).click()
    {
      const element = await driver.findElement(By.css("input"))
      await driver.actions({ bridge: true}).doubleClick(element).perform()
    }
    await driver.findElement(By.css("input")).sendKeys("5")
    await driver.findElement(By.css("input")).click()
    await driver.findElement(By.css("input")).sendKeys("6")
    await driver.findElement(By.css("input")).click()
    {
      const element = await driver.findElement(By.css("input"))
      await driver.actions({ bridge: true}).doubleClick(element).perform()
    }
    await driver.findElement(By.css("input")).sendKeys("7")
    await driver.findElement(By.css("input")).click()
    await driver.findElement(By.css("input")).sendKeys("8")
    await driver.findElement(By.css("input")).click()
    {
      const element = await driver.findElement(By.css("input"))
      await driver.actions({ bridge: true}).doubleClick(element).perform()
    }
    await driver.findElement(By.css("input")).sendKeys("9")
    await driver.findElement(By.css("input")).click()
    await driver.findElement(By.css("input")).sendKeys("10")
    await driver.findElement(By.css("input")).click()
    {
      const element = await driver.findElement(By.css("input"))
      await driver.actions({ bridge: true}).doubleClick(element).perform()
    }
    await driver.findElement(By.css(".btn-pay")).click()
  })
})