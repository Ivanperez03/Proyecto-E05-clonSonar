// Generated by Selenium IDE
const { Builder, By, Key, until } = require('selenium-webdriver')
const firefox = require('selenium-webdriver/firefox')
const assert = require('assert')

describe('anadirsaldo', function() {
  this.timeout(60000) // 60 segundos
  let driver
  let vars

  beforeEach(async function() {
    const options = new firefox.Options()
      .addArguments('--headless')
      .addArguments('--width=1920')
      .addArguments('--height=1080');

    driver = await new Builder()
      .forBrowser('firefox')
      .setFirefoxOptions(options)
      .build()
    vars = {}
  })

  afterEach(async function() {
    if (driver) await driver.quit();
  })

  it('anadirsaldo', async function() {
    // 1. Navegar
    await driver.get("http://localhost:5173/")
    
    // 2. Abrir Login y esperar de verdad
    await driver.wait(until.elementLocated(By.css(".ghost")), 10000);
    // Pausa pequeña para asegurar que la animación terminó
    await driver.sleep(1000); 
    await driver.findElement(By.css(".ghost")).click()
    
    // 3. RELLENAR EMAIL (Modo Lento)
    await driver.wait(until.elementLocated(By.css("label:nth-child(1) > input")), 5000);
    const emailInput = await driver.findElement(By.css("label:nth-child(1) > input"));
    
    await emailInput.click();
    await emailInput.clear();
    // Enviamos las teclas y esperamos un pelín
    await emailInput.sendKeys("pedrito@gmail.com");
    await driver.sleep(500); // Dar tiempo a Vue
    
    // 4. RELLENAR PASSWORD (Modo Lento)
    const passInput = await driver.findElement(By.css("label:nth-child(2) > input"));
    await passInput.click();
    await passInput.clear();
    await passInput.sendKeys("Pedrito");
    await driver.sleep(500); // Dar tiempo a Vue
    
    // TRUCO: Hacemos click en el título (H1) para quitar el foco de los inputs (Blur)
    // Esto obliga al navegador a confirmar los cambios en los campos
    try {
        await driver.findElement(By.css("h1")).click();
    } catch(e) {}
    
    // 5. CLICK EN ENTRAR
    await driver.findElement(By.css("button")).click()

    // 6. ESPERAR RESULTADO CON DIAGNÓSTICO
    try {
        // Esperamos a ver el botón de dentro (éxito)
        const botonAcciones = await driver.wait(
            until.elementLocated(By.css(".actions > .small")), 
            15000 
        );
        // Esperamos a que sea visible y clickeable
        await driver.wait(until.elementIsVisible(botonAcciones), 5000);
        await botonAcciones.click();

    } catch (error) {
        // SI FALLA, IMPRIMIMOS EL HTML PARA SABER QUÉ PASÓ
        console.log("\n################################################");
        console.log("⚠️ EL LOGIN FALLÓ. HTML DE LA PANTALLA:");
        try {
           // Imprimimos el texto visible de la web para ver el mensaje de error
           let bodyText = await driver.findElement(By.tagName("body")).getText();
           console.log(bodyText); 
        } catch(e) {}
        console.log("################################################\n");
        throw error;
    }

    // --- RESTO DEL TEST (Añadir saldo) ---
    // Si ha pasado el login, seguimos normal
    const saldo = await driver.wait(until.elementLocated(By.css(".saldo")), 5000);
    await saldo.click()
    
    await driver.findElement(By.css("input")).sendKeys("1")
    await driver.findElement(By.css("input")).click()
    await driver.findElement(By.css("input")).sendKeys("2")
    await driver.findElement(By.css("input")).click()
    {
      const element = await driver.findElement(By.css("input"))
      await driver.actions({ bridge: true}).doubleClick(element).perform()
    }
    await driver.findElement(By.css("input")).sendKeys("3")
    await driver.findElement(By.css("input")).click()
    await driver.findElement(By.css("input")).sendKeys("4")
    await driver.findElement(By.css("input")).click()
    {
      const element = await driver.findElement(By.css("input"))
      await driver.actions({ bridge: true}).doubleClick(element).perform()
    }
    await driver.findElement(By.css("input")).sendKeys("5")
    await driver.findElement(By.css("input")).click()
    await driver.findElement(By.css("input")).sendKeys("6")
    await driver.findElement(By.css("input")).click()
    {
      const element = await driver.findElement(By.css("input"))
      await driver.actions({ bridge: true}).doubleClick(element).perform()
    }
    await driver.findElement(By.css("input")).sendKeys("7")
    await driver.findElement(By.css("input")).click()
    await driver.findElement(By.css("input")).sendKeys("8")
    await driver.findElement(By.css("input")).click()
    {
      const element = await driver.findElement(By.css("input"))
      await driver.actions({ bridge: true}).doubleClick(element).perform()
    }
    await driver.findElement(By.css("input")).sendKeys("9")
    await driver.findElement(By.css("input")).click()
    await driver.findElement(By.css("input")).sendKeys("10")
    await driver.findElement(By.css("input")).click()
    {
      const element = await driver.findElement(By.css("input"))
      await driver.actions({ bridge: true}).doubleClick(element).perform()
    }
    await driver.findElement(By.css(".btn-pay")).click()
  })
})